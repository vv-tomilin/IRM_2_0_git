<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg width="162" version="1.2" xmlns="http://www.w3.org/2000/svg" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:atv="http://webmi.atvise.com/2007/svgext">
 <defs>
  <linearGradient id="linear_12" y1="1.01511" x1="0.443189" y2="-0.0183441" gradientUnits="objectBoundingBox" x2="0.443189">
   <stop offset="0.5065502183406113" stop-color="#646464"/>
   <stop offset="1" stop-color="#d0d0d0"/>
  </linearGradient>
 </defs>
 <desc>Sets/displays a time to/from an address.</desc>
 <title>In/Out Time</title>
 <metadata>
  <atv:parameter desc="base" valuetype="address" behavior="mandatory" name="base"/>
  <atv:parameter desc="interval [ms] (0 = off)" valuetype="number" behavior="optional" name="interval" defaultvalue="150"/>
  <atv:parameter desc="family" config="Times New Roman=Times New Roman,Bodoni,Garamond,Minion Web,ITC Stone Serif,MS Georgia,Bitstream Cyberbit,serif;Arial=MS Trebuchet,ITC Avant Garde Gothic,MS Arial,MS Verdana,Univers,Futura,ITC Stone Sans,Gill Sans,Akzidenz Grotesk,Helvetica,sans-serif;Courier=Courier,MS Courier New,Prestige,Everson Mono,monospace;Zapf-Chancery=Caflisch Script,Adobe Poetica,Sanvito,Ex Ponto,Snell Roundhand,Zapf-Chancery,cursive;Alpha Geometrique=Alpha Geometrique,Critter,Cottonwood,FB Reactor,Studz,fantasy" valuetype="enum" substitute="$FONTFAMILY$" group="Font" behavior="optional" name="fontFamily" defaultvalue="Arial"/>
  <atv:parameter desc="size" config="6;7;8;9;10;11;12;14;16;18" valuetype="enum" substitute="$FONTSIZE$" group="Font" behavior="optional" name="fontSize" defaultvalue="12"/>
  <atv:parameter desc="color" valuetype="color" group="Font" behavior="optional" name="fontColor" defaultvalue="#000000"/>
  <atv:parameter desc="fill color text" valuetype="color" group="Appearance" behavior="optional" name="valueFill" defaultvalue="#d0d0d0"/>
  <atv:parameter desc="fill color button" valuetype="color" group="Appearance" behavior="optional" name="buttonFill" defaultvalue="#495a6f"/>
  <atv:parameter desc="fill color arrow" valuetype="color" group="Appearance" behavior="optional" name="arrowFill" defaultvalue="#d0d0d0"/>
  <atv:parameter desc="fill color arrow pressed" valuetype="color" group="Appearance" behavior="optional" name="arrowFillPressed" defaultvalue="#FDFF0F"/>
  <atv:parameter desc="fill color when inactive" valuetype="color" group="Appearance" behavior="optional" name="fillColorInactive" defaultvalue="#8c8c8c"/>
  <atv:parameter desc="stroke color button pressed" valuetype="color" group="Appearance" behavior="optional" name="buttonStrokePressed" defaultvalue="#ffffff"/>
  <atv:parameter desc="focus stroke color" valuetype="color" group="Appearance" behavior="optional" name="focusStrokeColor" defaultvalue="#FFFFFF"/>
  <atv:parameter desc="minimum" valuetype="string" group="Options" behavior="optional" name="min"/>
  <atv:parameter desc="maximum" valuetype="string" group="Options" behavior="optional" name="max"/>
  <atv:parameter desc="address to set" valuetype="address" group="Options" behavior="optional" name="outputNode"/>
  <atv:parameter desc="consistency group" valuetype="string" group="Options" behavior="optional" name="consistencyGroup"/>
  <atv:parameter desc="tab index" valuetype="number" group="Options" behavior="optional" name="tabIndex"/>
  <atv:parameter desc="tooltip" valuetype="trstring" group="Options" behavior="optional" name="tooltip"/>
  <atv:parameter desc="necessary right" config="SYSTEM.SECURITY.RIGHTS" valuetype="address" group="Security" behavior="optional" name="right"/>
  <atv:parameter desc="activation address" valuetype="address" group="Security" behavior="optional" name="activeNode"/>
  <atv:parameter desc="activation value" valuetype="string" group="Security" behavior="optional" name="activeValue"/>
 </metadata>
 <rect width="161.5" x="0.25" y="0.25" fill="url(#linear_12)" atv:dynamic="true" rx="1.5" height="99.5" ry="1.5" stroke="#646464" id="id_0" atv:refpx="59.239" stroke-width="0.5" atv:refpy="50"/>
 <text x="21" y="15" fill="#000000" font-family="$FONTFAMILY$" text-anchor="middle" id="label_day" atv:refpx="17.5" atv:refpy="10.5" font-size="$FONTSIZE$">T{HH}</text>
 <text x="61" y="15" fill="#000000" font-family="$FONTFAMILY$" atv:dynamic="true" text-anchor="middle" id="label_month" atv:refpx="57.5" atv:refpy="10.5" font-size="$FONTSIZE$">T{MM}</text>
 <text x="101" y="15" fill="#000000" font-family="$FONTFAMILY$" text-anchor="middle" id="id_63" atv:refpx="98.324" atv:refpy="10.5" font-size="$FONTSIZE$">T{SS}</text>
 <svg width="40" x="1.224" y="19.224" height="80" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Steelblue.rocker_switch_small" id="1_hours" atv:refpx="41.224" atv:refpy="59.224">
  <atv:argument value="-1" name="min"/>
  <atv:argument value="24" name="max"/>
  <atv:argument prefix="interval" value="" name="interval"/>
  <atv:argument prefix="fontColor" value="" name="fontColor"/>
  <atv:argument prefix="buttonFill" value="" name="buttonFill"/>
  <atv:argument prefix="arrowFill" value="" name="arrowFill"/>
  <atv:argument prefix="arrowFillPressed" value="" name="arrowFillPressed"/>
  <atv:argument prefix="buttonStrokePressed" value="" name="buttonStrokePressed"/>
  <atv:argument prefix="right" value="" name="right"/>
  <atv:argument prefix="activeNode" value="" name="activeNode"/>
  <atv:argument prefix="activeValue" value="" name="activeValue"/>
  <atv:argument prefix="valueFill" value="" name="fill"/>
  <atv:argument prefix="fillColorInactive" value="" name="fillColorInactive"/>
  <atv:argument prefix="fontFamily" value="" name="fontFamily"/>
  <atv:argument prefix="fontSize" value="" name="fontSize"/>
  <atv:argument prefix="tabIndex" value=".4" name="tabIndex"/>
  <atv:argument prefix="focusStrokeColor" value="" name="focusStrokeColor"/>
  <atv:argument prefix="tooltip" value="" name="tooltip"/>
 </svg>
 <svg width="40" x="41" y="19" height="80" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Steelblue.rocker_switch_small" id="2_minutes" atv:refpx="61" atv:refpy="59">
  <atv:argument value="-1" name="min"/>
  <atv:argument value="60" name="max"/>
  <atv:argument prefix="interval" value="" name="interval"/>
  <atv:argument prefix="fontColor" value="" name="fontColor"/>
  <atv:argument prefix="buttonFill" value="" name="buttonFill"/>
  <atv:argument prefix="arrowFill" value="" name="arrowFill"/>
  <atv:argument prefix="arrowFillPressed" value="" name="arrowFillPressed"/>
  <atv:argument prefix="buttonStrokePressed" value="" name="buttonStrokePressed"/>
  <atv:argument prefix="right" value="" name="right"/>
  <atv:argument prefix="activeNode" value="" name="activeNode"/>
  <atv:argument prefix="activeValue" value="" name="activeValue"/>
  <atv:argument prefix="valueFill" value="" name="fill"/>
  <atv:argument prefix="fillColorInactive" value="" name="fillColorInactive"/>
  <atv:argument prefix="fontFamily" value="" name="fontFamily"/>
  <atv:argument prefix="fontSize" value="" name="fontSize"/>
  <atv:argument prefix="tabIndex" value=".5" name="tabIndex"/>
  <atv:argument prefix="focusStrokeColor" value="" name="focusStrokeColor"/>
  <atv:argument prefix="tooltip" value="" name="tooltip"/>
 </svg>
 <svg width="40" x="81" y="19" height="80" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Steelblue.rocker_switch_small" id="3_seconds" atv:refpx="101" atv:refpy="59">
  <atv:argument value="-1" name="min"/>
  <atv:argument value="60" name="max"/>
  <atv:argument prefix="interval" value="" name="interval"/>
  <atv:argument prefix="fontColor" value="" name="fontColor"/>
  <atv:argument prefix="buttonFill" value="" name="buttonFill"/>
  <atv:argument prefix="arrowFill" value="" name="arrowFill"/>
  <atv:argument prefix="arrowFillPressed" value="" name="arrowFillPressed"/>
  <atv:argument prefix="buttonStrokePressed" value="" name="buttonStrokePressed"/>
  <atv:argument prefix="right" value="" name="right"/>
  <atv:argument prefix="activeNode" value="" name="activeNode"/>
  <atv:argument prefix="activeValue" value="" name="activeValue"/>
  <atv:argument prefix="valueFill" value="" name="fill"/>
  <atv:argument prefix="fillColorInactive" value="" name="fillColorInactive"/>
  <atv:argument prefix="fontFamily" value="" name="fontFamily"/>
  <atv:argument prefix="fontSize" value="" name="fontSize"/>
  <atv:argument prefix="tabIndex" value=".6" name="tabIndex"/>
  <atv:argument prefix="focusStrokeColor" value="" name="focusStrokeColor"/>
  <atv:argument prefix="tooltip" value="" name="tooltip"/>
 </svg>
 <svg width="40" x="121.224" y="19" height="80" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Steelblue.rocker_switch_small" id="4_millis" atv:refpx="141.224" atv:refpy="59">
  <atv:argument value="1000" name="max"/>
  <atv:argument value="-1" name="min"/>
  <atv:argument prefix="interval" value="" name="interval"/>
  <atv:argument prefix="fontColor" value="" name="fontColor"/>
  <atv:argument prefix="buttonFill" value="" name="buttonFill"/>
  <atv:argument prefix="arrowFill" value="" name="arrowFill"/>
  <atv:argument prefix="arrowFillPressed" value="" name="arrowFillPressed"/>
  <atv:argument prefix="buttonStrokePressed" value="" name="buttonStrokePressed"/>
  <atv:argument prefix="right" value="" name="right"/>
  <atv:argument prefix="activeNode" value="" name="activeNode"/>
  <atv:argument prefix="activeValue" value="" name="activeValue"/>
  <atv:argument prefix="valueFill" value="" name="fill"/>
  <atv:argument prefix="fillColorInactive" value="" name="fillColorInactive"/>
  <atv:argument prefix="fontFamily" value="" name="fontFamily"/>
  <atv:argument prefix="fontSize" value="" name="fontSize"/>
  <atv:argument prefix="tabIndex" value=".7" name="tabIndex"/>
  <atv:argument prefix="focusStrokeColor" value="" name="focusStrokeColor"/>
  <atv:argument prefix="tooltip" value="" name="tooltip"/>
 </svg>
 <text x="141" y="15" fill="#000000" font-family="$FONTFAMILY$" atv:dynamic="true" text-anchor="middle" id="id_2" atv:refpx="136.739" atv:refpy="11.023" font-size="$FONTSIZE$">T{mmm}</text>
 <script type="text/ecmascript"><![CDATA[//connect to valuechanged-triggers
webMI.trigger.connect("valuechanged", function(e) { setField(e.value, "hours"); }, "1_hours");
webMI.trigger.connect("valuechanged", function(e) { setField(e.value, "minutes"); }, "2_minutes");
webMI.trigger.connect("valuechanged", function(e) {	setField(e.value, "seconds"); }, "3_seconds");
webMI.trigger.connect("valuechanged", function(e) {	setField(e.value, "millis"); }, "4_millis");

//connect to updateDate-trigger
webMI.trigger.connect("updateDate", function(e) {
	var date = new Date(e.value);
	_value.day = date.getDate();
	_value.month = date.getMonth();
	_value.year = date.getFullYear();
});

//connect to setValue-trigger
webMI.trigger.connect("setValue", function(e) {
	update(e.value);
});

//parameters
var base = (webMI.query["base"] == undefined) ? "" : webMI.query["base"];
var min = webMI.query["min"];
var max = webMI.query["max"];
var outputNode = webMI.query["outputNode"];
var consistencyGroup = webMI.query["consistencyGroup"];

// parameters passed through or not used in script
// var interval = parseFloat(webMI.query["interval"]);
// var fontFamily = webMI.query["fontFamily"];
// var fontSize = webMI.query["fontSize"];
// var fontColor = webMI.query["fontColor"];
// var buttonFill = webMI.query["buttonFill"];
// var arrowFill = webMI.query["arrowFill"];
// var arrowFillPressed = webMI.query["arrowFillPressed"];
// var buttonStrokePressed = webMI.query["buttonStrokePressed"];
// var right = webMI.query["right"];
// var activeNode = webMI.query["activeNode"];
// var activeValue = webMI.query["activeValue"];

//variables
var now = new Date();
var _value = { "date": now, "time": now.getTime(), "day": now.getDate(), "month": now.getMonth(), "year": now.getFullYear(), "hours": now.getHours(), "minutes": now.getMinutes(), "seconds": now.getSeconds(), "millis": now.getMilliseconds() };
var minTime, maxTime;
var oneSecond = 1000;
var oneMinute = oneSecond * 60;
var oneHour = oneMinute * 60;

if (consistencyGroup)
	var consistencyHandler = webMI.callExtension("SYSTEM.LIBRARY.ATVISE.QUICKDYNAMICS.Consistency Handler");

//set minimum time
if (min) {
	minTime = parseTime(min);
}

//set maximum time
if (max) {
	maxTime = parseTime(max);
}

//subscribe to node
if (base != "") {
	if (consistencyGroup) {
		consistencyHandler.register(consistencyGroup, base, update);
	} else {
		webMI.data.subscribe(base, function(e) {
			var millis = 0;

			//check if a value is given
			if (e.value) {
				millis = e.value;

				//if not number, try to parse
				if (typeof millis != "number") {
					millis = parseInt(e.value, 10);

					if (isNaN(millis)) {
						millis = 0;
					}
				}
			}

			//set new time
			var newDate = new Date(millis);
			_value.day = newDate.getDate();
			_value.month = newDate.getMonth();
			_value.year = newDate.getFullYear();
			_value.hours = newDate.getHours();
			_value.minutes = newDate.getMinutes();
			_value.seconds = newDate.getSeconds();
			_value.millis = newDate.getMilliseconds();
			
			//set internal time and update display
			updateDate();
			updateDisplay();
		});
	}
//no base defined
} else {
	//set internal time and display initial value
	updateDate();
	updateDisplay();
}

/*
 * FUNCTIONS
 */

//set hours, minutes, seconds, millis
function setField(value, button) {
	//convert to number if not
	if (typeof value != "number" || isNaN(value)) {
		value = parseInt(value, 10);
		
		if (isNaN(value)) {
			value = 0;
		}
	}

	_value[button] = value;
	
	updateDate();
	valueUpdated(true);
	
	//update displayed values only 
	if ((base == undefined) || (base == "")) {
		updateDisplay();
	}
}

//parse string to milliseconds
function parseTime(str) {
	//parse string in correct format to date object
	var time = 0;
	
	if (typeof str == "string" && str) {
		var match = str.match(/\d+/g);
	
		if (match) {
			var hours = match[0];
			var minutes = match[1];
			var seconds = match[2];
			var millis = match[3];
			
			if (!hours) { hours = 0; }
			if (!minutes) { minutes = 0; }
			if (!seconds) { seconds = 0; }
			if (!millis) { millis = 0; }

			time += hours * oneHour;
			time += minutes * oneMinute;
			time += seconds * oneSecond;
			time += millis * 1;
		}
	}
	
	return time;
}

//update display
function updateDisplay() {
	webMI.trigger.fire("setValue", _value.hours, "1_hours");
	webMI.trigger.fire("setValue", _value.minutes, "2_minutes");
	webMI.trigger.fire("setValue", _value.seconds, "3_seconds");
	webMI.trigger.fire("setValue", _value.millis, "4_millis");
}

//set time
function updateDate() {
	var time = 0;
		time += _value.hours * oneHour;
		time += _value.minutes * oneMinute;
		time += _value.seconds * oneSecond;
		time += _value.millis;
		
	//check against maxTime
	if (maxTime && (time > maxTime)) {
		_value.hours = Math.floor( maxTime / oneHour );
		_value.minutes = Math.floor( (maxTime % oneHour) / oneMinute );
		_value.seconds = Math.floor( ((maxTime % oneHour) % oneMinute) / oneSecond );
		_value.millis = ((maxTime % oneHour) % oneMinute) % oneSecond;
	//check against minTime
	} else if (minTime && (time < minTime)) {
		_value.hours = Math.floor( minTime / oneHour );
		_value.minutes = Math.floor( (minTime % oneHour) / oneMinute );
		_value.seconds = Math.floor( ((minTime % oneHour) % oneMinute) / oneSecond );
		_value.millis = ((minTime % oneHour) % oneMinute) % oneSecond;
	}
	
	_value.date = new Date(_value.year, _value.month, _value.day, _value.hours, _value.minutes, _value.seconds, _value.millis);
	_value.time = _value.date.getTime();
	_value.day = _value.date.getDate();
	_value.month = _value.date.getMonth();
	_value.year = _value.date.getFullYear();
	_value.hours = _value.date.getHours();
	_value.minutes = _value.date.getMinutes();
	_value.seconds = _value.date.getSeconds();
	_value.millis = _value.date.getMilliseconds();
}

//value has been changed by display
function valueUpdated(fireTrigger) {
	//update node
	if (base != "" && !consistencyGroup) {
		webMI.data.write(base, _value.time);
	}

	if (outputNode) {
		webMI.data.write(outputNode, _value.time);
	}
	
	//fire trigger
	if (fireTrigger) {
		webMI.trigger.fire("valuechanged", _value.time, "");
	}

	//update consistency value
	if (consistencyGroup)
		consistencyHandler.set(consistencyGroup, base, _value.time);
}

//update externally by trigger or consistency handler
function update(value) {
	var date = new Date(value);
	_value.day = date.getDate();
	_value.month = date.getMonth();
	_value.year = date.getFullYear();
	_value.hours = date.getHours();
	_value.minutes = date.getMinutes();
	_value.seconds = date.getSeconds();
	_value.millis = date.getMilliseconds();

	updateDate();
	//valueUpdated(false);

	//update displayed values only
	if ((base == "") || (base == undefined) || consistencyGroup) {
		updateDisplay();
	}
}]]></script>
</svg>
