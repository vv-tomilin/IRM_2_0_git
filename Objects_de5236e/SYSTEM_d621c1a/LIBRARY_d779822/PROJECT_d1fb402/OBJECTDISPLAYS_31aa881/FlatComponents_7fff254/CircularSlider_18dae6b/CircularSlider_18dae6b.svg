<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg width="378" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" version="1.2" xmlns="http://www.w3.org/2000/svg" height="328" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:svg="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext">
 <defs>
  <linearGradient id="linear_0" y1="1.01562" x1="-0.015625" y2="0.1875" gradientUnits="objectBoundingBox" x2="0">
   <stop offset="0" stop-color="#ff0000"/>
   <stop offset="1" stop-color="#00ff51"/>
  </linearGradient>
 </defs>
 <desc>Allows editing a numeric value by dragging or via keyboard.</desc>
 <title>Circular Slider</title>
 <metadata>
  <atv:parameter desc="label" valuetype="trstring" substitute="$TEXT$" behavior="optional" name="â€¢" defaultvalue="T{Speed setting}"/>
  <atv:parameter desc="minimum" valuetype="number" substitute="$MIN$" group="Value" behavior="optional" name="minValue" defaultvalue="0"/>
  <atv:parameter desc="maximum" valuetype="number" substitute="$MAX$" group="Value" behavior="optional" name="maxValue" defaultvalue="100"/>
  <atv:parameter desc="displayed unit" valuetype="trstring" group="Number Format" behavior="optional" name="unit"/>
  <atv:parameter desc="show sign" valuetype="bool" group="Number Format" behavior="optional" name="sign" defaultvalue="false"/>
  <atv:parameter desc="leading zeros" valuetype="number" group="Number Format" behavior="optional" name="leadingZeros" defaultvalue="0"/>
  <atv:parameter desc="post decimal positions" valuetype="number" group="Number Format" behavior="optional" name="postDecimal" defaultvalue="0"/>
  <atv:parameter desc="force decimal fraction position" valuetype="number" group="Number Format" behavior="optional" name="decimalFraction" defaultvalue=""/>
  <atv:parameter desc="show value" valuetype="bool" group="Value" behavior="optional" name="showValue" defaultvalue="true"/>
  <atv:parameter config="Times New Roman=Times New Roman,Bodoni,Garamond,Minion Web,ITC Stone Serif,MS Georgia,Bitstream Cyberbit,serif;Arial=MS Trebuchet,ITC Avant Garde Gothic,MS Arial,MS Verdana,Univers,Futura,ITC Stone Sans,Gill Sans,Akzidenz Grotesk,Helvetica,sans-serif;Courier=Courier,MS Courier New,Prestige,Everson Mono,monospace;Zapf-Chancery=Caflisch Script,Adobe Poetica,Sanvito,Ex Ponto,Snell Roundhand,Zapf-Chancery,cursive;Alpha Geometrique=Alpha Geometrique,Critter,Cottonwood,FB Reactor,Studz,fantasy" desc="family" valuetype="enum" substitute="$FONTFAMILY$" group="Font" behavior="optional" name="fontFamily" defaultvalue="Arial"/>
  <atv:parameter config="6;7;8;9;10;11;12;14;16;18;20;22;24;26;28;36;48;72" desc="size" valuetype="enum" substitute="$FONTSIZE$" group="Font" behavior="optional" name="fontSize" defaultvalue="16"/>
  <atv:parameter desc="color gauge" valuetype="color" substitute="$COLORGAUGE$" group="Colors" behavior="optional" name="colorGauge" defaultvalue="#E3D700"/>
  <atv:parameter desc="color label" valuetype="color" substitute="$COLORLABEL$" group="Colors" behavior="optional" name="colorLabel" defaultvalue="#B3B3B3"/>
  <atv:parameter desc="limit low low (off=no limit)" valuetype="string" substitute="" group="Limit" behavior="optional" name="limitLowLow" defaultvalue="off"/>
  <atv:parameter desc="limit low (off=no limit)" valuetype="string" substitute="" group="Limit" behavior="optional" name="limitLow" defaultvalue="off"/>
  <atv:parameter desc="limit high (off=no limit)" valuetype="string" substitute="" group="Limit" behavior="optional" name="limitHigh" defaultvalue="off"/>
  <atv:parameter desc="limit high high (off=no limit)" valuetype="string" group="Limit" behavior="optional" name="limitHighHigh" defaultvalue="off"/>
  <atv:parameter desc="limit low low color" valuetype="color" substitute="" group="Limit" behavior="optional" name="limitLowLowColor" defaultvalue="#ff0000"/>
  <atv:parameter desc="limit low color" valuetype="color" group="Limit" behavior="optional" name="limitLowColor" defaultvalue="#ffff00"/>
  <atv:parameter desc="limit high color" valuetype="color" group="Limit" behavior="optional" name="limitHighColor" defaultvalue="#ffff00"/>
  <atv:parameter desc="limit high high color" valuetype="color" group="Limit" behavior="optional" name="limitHighHighColor" defaultvalue="#ff0000"/>
  <atv:parameter desc="desired value" valuetype="address" substitute="" group="Value" behavior="optional" name="desiredValue" defaultvalue=""/>
  <atv:parameter desc="value address" valuetype="address" substitute="$ADDRESS$" behavior="hidden" name="valueAddress" defaultvalue=""/>
  <atv:gridconfig width="20" enabled="false" height="20" gridstyle="lines"/>
  <atv:snapconfig width="10" enabled="false" height="10"/>
 </metadata>
 <text x="118.784" y="322.29" atv:bindtl="0,1" fill="$COLORLABEL$" font-family="$FONTFAMILY$" text-anchor="end" atv:bindbr="0,1" id="id_3" atv:refpx="113.284" atv:refpy="317.79" font-size="18">$MIN$</text>
 <text x="189" y="13.483" fill="$COLORLABEL$" font-family="$FONTFAMILY$" text-anchor="middle" id="halfLabel" atv:refpx="187.77" atv:refpy="8.983" font-size="18">50</text>
 <text x="259.217" y="322.29" atv:bindtl="1,1" fill="$COLORLABEL$" font-family="$FONTFAMILY$" text-anchor="start" atv:bindbr="1,1" id="id_8" atv:refpx="271.606" atv:refpy="317.79" font-size="18">$MAX$</text>
 <text x="46.5" y="128" atv:bindtl="0,1" fill="$COLORLABEL$" font-family="$FONTFAMILY$" text-anchor="end" atv:bindbr="0,1" id="quarterLabel" atv:refpx="35.444" atv:refpy="123.5" font-size="18">25</text>
 <text x="331.5" y="128" atv:bindtl="1,1" fill="$COLORLABEL$" font-family="$FONTFAMILY$" text-anchor="start" atv:bindbr="1,1" id="threeQuarterLabel" atv:refpx="339.444" atv:refpy="123.5" font-size="18">75</text>
 <g id="id_4" atv:refpx="169" atv:refpy="154.318" transform="matrix(1,0,0,1,24,20)">
  <path fill="#dedede" id="id_0" atv:refpx="165" atv:refpy="134.318" d="M165,0C85.472,0 21,64.477 21,144C21,197.23 49.89,243.714 92.842,268.635L98.856,258.248C59.483,235.403 33,192.793 33,144C33,71.105 92.102,12 165,12C237.898,12 297,71.104 297,144C297,192.793 270.518,235.403 231.144,258.249L237.159,268.636C280.11,243.714 309,197.23 309,144C309,64.477 244.528,0 165,0"/>
 </g>
 <rect width="290" x="44" y="19" fill="none" height="290" stroke="none" id="rect" atv:refpx="189" stroke-width="0" atv:refpy="164"/>
 <circle fill="none" cx="189" cy="164" stroke="none" r="144" id="id_outer_circle" atv:refpx="189" stroke-width="0" atv:refpy="164"/>
 <text x="179.282" y="137.857" atv:bindtl="0.5,0.5" fill="$COLORLABEL$" font-family="$FONTFAMILY$" text-anchor="middle" atv:bindbr="0.5,0.5" id="id_2" atv:refpx="189" atv:refpy="135.714" font-size="$FONTSIZE$" transform="matrix(1.1429,0,0,1.1429,-15.9022,-16.6989)">$TEXT$</text>
 <svg width="80" x="54.5" y="79" height="31" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.FlatComponents.EditableLabel" id="id_6" atv:refpx="189" atv:refpy="189" transform="matrix(2,0,0,2,0,0)">
  <atv:argument value="36" name="fontSize"/>
  <atv:argument prefix="base" name="base"/>
  <atv:argument prefix="minValue" value="" name="min"/>
  <atv:argument prefix="maxValue" value="" name="max"/>
  <atv:argument prefix="desiredValue" name="outputNode"/>
  <atv:argument prefix="leadingZeros" value="" name="leadingZeros"/>
  <atv:argument prefix="postDecimal" value="" name="postDecimal"/>
  <atv:argument prefix="decimalFraction" name="decimalFraction"/>
  <atv:argument prefix="unit" name="unit"/>
  <atv:argument prefix="sign" name="sign"/>
  <atv:argument prefix="fontFamily" name="fontFamily"/>
  <atv:overwrite x="80" y="44" id="input_label" transform="matrix(0.5,0,0,0.5,0,0)"/>
  <atv:overwrite width="159" height="61" id="input_bg" transform="matrix(0.5,0,0,0.5,0,0)"/>
  <atv:overwrite width="232.326" height="77.5" id="blinking_frame" transform="matrix(0.5,0,0,0.5,0,0)"/>
 </svg>
 <path visibility="hidden" stroke="$COLORGAUGE$" stroke-linejoin="miter" fill-opacity="0" id="gauge" stroke-linecap="square" atv:refpx="87.333" stroke-width="12.5" atv:refpy="249.669" d="M115.128,281.773L84.806,255.8L71.81,238.486L59.537,217.564"/>
 <g id="toucharea" atv:refpx="189.736" atv:refpy="164" transform="matrix(1,0,0,1,33.236,7.5)">
  <circle fill="$COLORGAUGE$" cx="156.5" cy="17.5" r="25" id="id_1" atv:refpx="156.5" atv:refpy="17.5"/>
  <path fill="#0000fe" fill-opacity="0.00392157" id="path2996" atv:refpx="196.5" atv:refpy="171.499" d="M155.764,12.499C76.235,12.499 11.763,76.971 11.763,156.499C11.763,236.028 76.235,300.499 155.764,300.499C235.293,300.499 299.764,236.028 299.764,156.499C299.764,76.971 235.293,12.499 155.764,12.499M155.764,24.5C228.664,24.5 287.764,83.598 287.764,156.499C287.764,229.4 228.664,288.499 155.764,288.499C82.862,288.499 23.763,229.4 23.763,156.499C23.763,83.598 82.862,24.5 155.764,24.5"/>
 </g>
 <script type="text/ecmascript"><![CDATA[var base = webMI.query["base"],
	minValue = (webMI.query["minValue"] == undefined) ? "" : parseFloat(webMI.query["minValue"]),
	maxValue = (webMI.query["maxValue"] == undefined) ? "" : parseFloat(webMI.query["maxValue"]),
	showValue = (webMI.query["showValue"] == undefined) ? "" : webMI.query["showValue"],
	valueAddress = webMI.query.valueAddress = (webMI.query.desiredValue != '') ? webMI.query.desiredValue : base

function draw(pathItem, cx, cy, radiusX, radiusY, startA, endA)
{	
	if (isNaN(cx)) return;
	if (isNaN(cy)) return;
	if (isNaN(radiusX)) return;
	if (isNaN(radiusY)) return;
	if (isNaN(startA)) return;
	if (isNaN(endA)) return;

	var startAngle = parseFloat(startA) + 120.0;
	var endAngle = parseFloat(endA) + 120.0;

	var x1 = parseFloat(parseFloat(cx) + parseFloat(radiusX) * Math.cos(Math.PI*startAngle/180.0));
	var y1 = parseFloat(parseFloat(cy) + parseFloat(radiusY) * Math.sin(Math.PI*startAngle/180.0));

	var x2 = parseFloat(parseFloat(cx) + parseFloat(radiusX) * Math.cos(Math.PI*endAngle/180.0));
	var y2 = parseFloat(parseFloat(cy) + parseFloat(radiusY) * Math.sin(Math.PI*endAngle/180.0));                

	if (endA-startA >= 180) {
		var d = "M" + x1 + "," + y1 + "  A" + radiusX + "," + radiusY + " 0 1,1 " + x2 + "," + y2;
	}
	else {
		var d = "M" + x1 + "," + y1 + "  A" + radiusX + "," + radiusY + " 0 0,1 " + x2 + "," + y2;
	}
	pathItem.setAttribute("d", d);
}

function calculateAngle(value, min, max) {
	var maxAngle = 300.0;
	if (value <= min)
		return 0.0;
	if (value >= max)
		return maxAngle;
	if (min > max - 0.00001)
		return 0.0;
	
	return maxAngle * (value-min) / (max-min);
}

function getWidgetAttribute(widget, attr){
	return(widget.getAttribute(attr));
}

webMI.data.read(base + "", function(e) {
	var id = "text";
	var value = e.value;
	if (isNaN(value))
	{
		webMI.gfx.setText(id, "-");
		return;
	}
	
	webMI.gfx.setText(id, webMI.sprintf(webMI.query["formatString"], value));
	
	if (showValue == "true") {
		webMI.gfx.setVisible(id, true);
	}
	else {
		webMI.gfx.setVisible(id, false);
	}
});

webMI.data.subscribe(base, function(e) {
	updateGauge(e.value);
});

function updateGauge(e) {
	var pathItem = document.getElementById("gauge");

	var circleItem = document.getElementById("id_outer_circle");
	var rectItem = document.getElementById("rect");
	var value = e;

	var centerX = parseInt(getWidgetAttribute(circleItem, "cx"));
	var centerY = parseInt(getWidgetAttribute(circleItem, "cy"));
	var radiusX = parseInt(getWidgetAttribute(rectItem, "width") / 2 - 7);
	var radiusY = parseInt(getWidgetAttribute(rectItem, "height") / 2 - 7);
	var angle = calculateAngle(value, minValue, maxValue);

	draw(pathItem, centerX, centerY, radiusX, radiusY, 0.0, angle);

	webMI.gfx.setVisible("gauge", true);
}

webMI.trigger.connect("rotateValue" + base, function(e){
	webMI.gfx.setText("text", e.value);
	webMI.trigger.fire("setValue", e.value, "id_7");
	updateGauge(e.value);
})

webMI.callExtension("SYSTEM.LIBRARY.PROJECT.QUICKDYNAMICS.TouchRotate", {
	"id": "toucharea",
	"ele": document.getElementById("toucharea"),
	"node": valueAddress,
	"minValue": minValue,
	"maxValue": maxValue,
	"minAngle": -150,
	"maxAngle": 150
});

(function() {
	var valueRange = maxValue - minValue,
		quarter = minValue + valueRange / 4,
		half = minValue + valueRange / 2,
		threeQuarter = minValue + valueRange / 4 * 3;

	webMI.gfx.setText('quarterLabel', quarter + '');
	webMI.gfx.setText('halfLabel', half + '');
	webMI.gfx.setText('threeQuarterLabel', threeQuarter + '');
})()

var originalGaugeColor = webMI.query["colorGauge"];

var possibleLimits = [
	{ name: "limitLow", reached: reachedSmaller },
	{ name: "limitHigh", reached: reachedBigger },
	{ name: "limitLowLow", reached: reachedSmaller },
	{ name: "limitHighHigh", reached: reachedBigger }
];

var limitsToApply = [];

function limitSet(limit) {
	var value = webMI.query[limit.name];

	if (value && value != 'off') {
		limit.value = value;
		limit.color = webMI.query[limit.name + 'Color'];

		return true;
	}

	return false;
}

function anyLimitSet() {
	for (var i = 0; i < possibleLimits.length; i++) {
		var test = possibleLimits[i];

		if (limitSet(test))
			limitsToApply.push(test);
	}
	return (limitsToApply.length > 0);
}

function applyLimit(limit, value) {
	return (limit.reached(value)) ? limit.color : false;
}

function reachedSmaller(value) { return value <= this.value };

function reachedBigger(value) { return value >= this.value };

function updateLimits(e) {
	var result = originalGaugeColor,
		value = e.value;

	for (var i = 0; i < limitsToApply.length; i++) {
		result = applyLimit(limitsToApply[i], value) || result;
	}
	updateDisplay(result);
}

function updateDisplay(gaugeColor) {
	webMI.gfx.setStroke('gauge', gaugeColor);
	webMI.gfx.setFill('id_1', gaugeColor);
}

if (anyLimitSet()) webMI.data.subscribe(base + "", updateLimits);]]></script>
</svg>
